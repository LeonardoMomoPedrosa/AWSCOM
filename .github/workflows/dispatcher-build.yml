name: Deploy Dispatcher (Python)

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'SLCOM/Dispatcher/**'
      - '.github/workflows/dispatcher-build.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'SLCOM/Dispatcher/**'
  workflow_dispatch:

jobs:

  pre-actions:
    name: Pre Actions
    runs-on: ubuntu-latest
    steps:
      - name: Contexto
        run: |
          echo "üîß Iniciando pipeline Dispatcher..."
          echo "üì¶ Script Python para envio de emails via TRANSACTION_LOG"

  open-ssh-port:
    name: Abrir porta SSH AWS (22)
    runs-on: ubuntu-latest
    needs: pre-actions
    steps:
      - name: Configurar credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Abrir porta SSH temporariamente
        run: |
          aws ec2 authorize-security-group-ingress \
          --group-id ${{ secrets.BASTION_SG_ID }} \
          --protocol tcp --port 22 --cidr 0.0.0.0/0 || echo "‚ö†Ô∏è Regra j√° existente"

  prepare-files:
    name: Preparar arquivos
    runs-on: ubuntu-latest
    needs: pre-actions
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Criar arquivo de informa√ß√µes do build
        run: |
          cat > SLCOM/Dispatcher/BUILD_INFO.txt <<EOF
          Build: ${{ github.run_number }}
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Data: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Autor: ${{ github.actor }}
          EOF

      - name: Compactar arquivos
        run: |
          cd SLCOM/Dispatcher
          zip -r ../../dispatcher.zip .
          cd ../..
          ls -lh dispatcher.zip

      - name: Armazenar artefato no GitHub
        uses: actions/upload-artifact@v4
        with:
          name: Dispatcher
          path: dispatcher.zip
          retention-days: 30

  transfer-bastion:
    name: Transfer para Bastion
    runs-on: ubuntu-latest
    needs: [ prepare-files, open-ssh-port ]
    steps:
      - name: Aguardar propaga√ß√£o da regra SSH
        run: |
          echo "‚è≥ Aguardando 10 segundos para garantir que a porta SSH est√° aberta..."
          sleep 10
          echo "‚úÖ Prosseguindo com o transfer"
      
      - name: Testar conectividade SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USERNAME }}
          key: ${{ secrets.BASTION_SSH_KEY }}
          script: |
            echo "‚úÖ Conectado no Bastion com sucesso!"
            whoami
            pwd
            ls -la /home/ec2-user/deploys/ || mkdir -p /home/ec2-user/deploys/
      
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: Dispatcher

      - name: Verificar arquivo baixado
        run: |
          echo "=== Conte√∫do do diret√≥rio atual ==="
          pwd
          ls -la
          echo ""
          echo "=== Verificando arquivo espec√≠fico ==="
          if [ -f "dispatcher.zip" ]; then
            ls -lh dispatcher.zip
            echo "‚úÖ Arquivo encontrado!"
          else
            echo "‚ùå Arquivo dispatcher.zip N√ÉO encontrado!"
            echo "Procurando arquivos .zip:"
            find . -name "*.zip" -type f
          fi

      - name: Enviar artefato para o Bastion
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USERNAME }}
          key: ${{ secrets.BASTION_SSH_KEY }}
          source: "dispatcher.zip"
          target: "/home/ec2-user/deploys/"

  deploy-bastion:
    name: Deploy no Bastion (Dispatcher2)
    runs-on: ubuntu-latest
    needs: transfer-bastion
    steps:
      - name: Descompactar e configurar no Bastion
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USERNAME }}
          key: ${{ secrets.BASTION_SSH_KEY }}
          script_stop: false
          script: |
            set -e
            echo "=========================================="
            echo "  Deploy Dispatcher no Bastion"
            echo "=========================================="
            
            DEPLOY_ZIP="/home/ec2-user/deploys/dispatcher.zip"
            TARGET_DIR="$HOME/Dispatcher2"
            BACKUP_DIR="$HOME/Dispatcher2-backup-$(date +%Y%m%d-%H%M%S)"
            
            # Verificar se arquivo foi enviado
            if [ ! -f "$DEPLOY_ZIP" ]; then
              echo "‚ùå Arquivo $DEPLOY_ZIP n√£o encontrado!"
              exit 1
            fi
            
            echo "‚úÖ Arquivo encontrado: $DEPLOY_ZIP"
            ls -lh "$DEPLOY_ZIP"
            
            # Fazer backup da vers√£o anterior (se existir)
            if [ -d "$TARGET_DIR" ]; then
              echo "üì¶ Criando backup da vers√£o anterior..."
              cp -r "$TARGET_DIR" "$BACKUP_DIR"
              echo "‚úÖ Backup criado em: $BACKUP_DIR"
            fi
            
            # Criar diret√≥rio de destino
            echo "üìÅ Preparando diret√≥rio $TARGET_DIR..."
            mkdir -p "$TARGET_DIR"
            
            # Limpar arquivos antigos
            echo "üßπ Limpando arquivos antigos..."
            rm -rf "$TARGET_DIR"/*
            
            # Extrair novo pacote
            echo "üì¶ Extraindo pacote..."
            unzip -o "$DEPLOY_ZIP" -d "$TARGET_DIR"
            
            # Ajustar permiss√µes
            echo "üîê Ajustando permiss√µes..."
            chmod +x "$TARGET_DIR"/*.py || true
            find "$TARGET_DIR" -type f -name "*.py" -exec chmod 755 {} \;
            
            # Verificar instala√ß√£o
            echo ""
            echo "=========================================="
            echo "  ‚úÖ Deploy conclu√≠do com sucesso!"
            echo "=========================================="
            echo ""
            echo "üìÇ Localiza√ß√£o: $TARGET_DIR"
            echo "üìã Arquivos instalados:"
            ls -lh "$TARGET_DIR" | head -20
            echo ""
            
            # Mostrar informa√ß√µes do build
            if [ -f "$TARGET_DIR/BUILD_INFO.txt" ]; then
              echo "üìù Informa√ß√µes do Build:"
              cat "$TARGET_DIR/BUILD_INFO.txt"
              echo ""
            fi
            
            # Verificar se Python est√° instalado
            if command -v python3 &> /dev/null; then
              echo "‚úÖ Python instalado: $(python3 --version)"
            else
              echo "‚ö†Ô∏è Python n√£o encontrado!"
            fi
            
            echo ""
            echo "=========================================="
            echo "  üìã Como executar:"
            echo "=========================================="
            echo "  cd ~/Dispatcher2"
            echo "  python3 EmailJob.py"
            echo ""
            echo "  Ou configure no cron (a cada 5 minutos):"
            echo "  */5 * * * * cd ~/Dispatcher2 && /usr/bin/python3 EmailJob.py >> ~/Dispatcher2/dispatcher.log 2>&1"
            echo "=========================================="

  close-ssh-port:
    name: Fechar porta SSH AWS (22)
    runs-on: ubuntu-latest
    needs: [ open-ssh-port, deploy-bastion ]
    if: always()
    steps:
      - name: Configurar credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Fechar porta SSH
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.BASTION_SG_ID }} \
            --protocol tcp --port 22 --cidr 0.0.0.0/0 || echo "‚ö†Ô∏è Regra j√° removida"

  post-actions:
    name: Post Actions
    runs-on: ubuntu-latest
    needs: [ prepare-files, transfer-bastion, deploy-bastion, close-ssh-port ]
    if: always()
    steps:
      - name: Resumo
        run: |
          echo "=========================================="
          echo "  üèÅ Pipeline Dispatcher Finalizado"
          echo "=========================================="
          echo ""
          echo "üìä Status dos Jobs:"
          echo "  prepare-files: ${{ needs.prepare-files.result }}"
          echo "  transfer-bastion: ${{ needs['transfer-bastion'].result }}"
          echo "  deploy-bastion: ${{ needs['deploy-bastion'].result }}"
          echo "  close-ssh-port: ${{ needs['close-ssh-port'].result }}"
          echo ""
          echo "=========================================="
          
          if [ "${{ needs.prepare-files.result }}" == "success" ] && \
             [ "${{ needs['transfer-bastion'].result }}" == "success" ] && \
             [ "${{ needs['deploy-bastion'].result }}" == "success" ]; then
            echo "‚úÖ Deploy conclu√≠do com sucesso!"
            echo "üìÇ Aplica√ß√£o dispon√≠vel em: ~/Dispatcher2"
            echo "üöÄ Execute manualmente ou configure no cron"
          else
            echo "‚ùå Pipeline teve falhas. Verifique os logs acima."
          fi

