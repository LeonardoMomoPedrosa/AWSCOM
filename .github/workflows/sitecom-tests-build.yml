name: Deploy SITECOM Tests (Python)

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'SITECOM/Tests/**'
      - '.github/workflows/sitecom-tests-build.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'SITECOM/Tests/**'
  workflow_dispatch:

jobs:

  pre-actions:
    name: Pre Actions
    runs-on: ubuntu-latest
    steps:
      - name: Contexto
        run: |
          echo "üîß Iniciando pipeline SITECOM Tests..."
          echo "üì¶ Script Python para envio de buslog.json para API webhook"

  open-ssh-port:
    name: Abrir porta SSH AWS (22)
    runs-on: ubuntu-latest
    needs: pre-actions
    steps:
      - name: Configurar credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Abrir porta SSH temporariamente
        run: |
          aws ec2 authorize-security-group-ingress \
          --group-id ${{ secrets.BASTION_SG_ID }} \
          --protocol tcp --port 22 --cidr 0.0.0.0/0 || echo "‚ö†Ô∏è Regra j√° existente"

  prepare-files:
    name: Preparar arquivos
    runs-on: ubuntu-latest
    needs: pre-actions
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Criar arquivo de informa√ß√µes do build
        run: |
          cat > SITECOM/Tests/BUILD_INFO.txt <<EOF
          Build: ${{ github.run_number }}
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Data: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Autor: ${{ github.actor }}
          EOF

      - name: Compactar arquivos
        run: |
          cd SITECOM/Tests
          zip -r ../../sitecom-tests.zip .
          cd ../..
          ls -lh sitecom-tests.zip

      - name: Armazenar artefato no GitHub
        uses: actions/upload-artifact@v4
        with:
          name: SITECOM-Tests
          path: sitecom-tests.zip
          retention-days: 30

  transfer-bastion:
    name: Transfer para Bastion
    runs-on: ubuntu-latest
    needs: [ prepare-files, open-ssh-port ]
    steps:
      - name: Aguardar propaga√ß√£o da regra SSH
        run: |
          echo "‚è≥ Aguardando 10 segundos para garantir que a porta SSH est√° aberta..."
          sleep 10
          echo "‚úÖ Prosseguindo com o transfer"
      
      - name: Testar conectividade SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USERNAME }}
          key: ${{ secrets.BASTION_SSH_KEY }}
          script: |
            echo "‚úÖ Conectado no Bastion com sucesso!"
            whoami
            pwd
            ls -la /home/ec2-user/deploys/ || mkdir -p /home/ec2-user/deploys/
      
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: SITECOM-Tests

      - name: Verificar arquivo baixado
        run: |
          echo "=== Conte√∫do do diret√≥rio atual ==="
          pwd
          ls -la
          echo ""
          echo "=== Verificando arquivo espec√≠fico ==="
          if [ -f "sitecom-tests.zip" ]; then
            ls -lh sitecom-tests.zip
            echo "‚úÖ Arquivo encontrado!"
          else
            echo "‚ùå Arquivo sitecom-tests.zip N√ÉO encontrado!"
            echo "Procurando arquivos .zip:"
            find . -name "*.zip" -type f
          fi

      - name: Enviar artefato para o Bastion
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USERNAME }}
          key: ${{ secrets.BASTION_SSH_KEY }}
          source: "sitecom-tests.zip"
          target: "/home/ec2-user/deploys/"

  deploy-bastion:
    name: Deploy no Bastion (SITECOM/Tests)
    runs-on: ubuntu-latest
    needs: transfer-bastion
    steps:
      - name: Descompactar e configurar no Bastion
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USERNAME }}
          key: ${{ secrets.BASTION_SSH_KEY }}
          script_stop: false
          script: |
            set -e
            echo "=========================================="
            echo "  Deploy SITECOM Tests no Bastion"
            echo "=========================================="
            
            DEPLOY_ZIP="/home/ec2-user/deploys/sitecom-tests.zip"
            TARGET_DIR="$HOME/SITECOM/Tests"
            BACKUP_DIR="$HOME/SITECOM/Tests-backup-$(date +%Y%m%d-%H%M%S)"
            
            # Verificar se arquivo foi enviado
            if [ ! -f "$DEPLOY_ZIP" ]; then
              echo "‚ùå Arquivo $DEPLOY_ZIP n√£o encontrado!"
              exit 1
            fi
            
            echo "‚úÖ Arquivo encontrado: $DEPLOY_ZIP"
            ls -lh "$DEPLOY_ZIP"
            
            # Fazer backup da vers√£o anterior (se existir)
            if [ -d "$TARGET_DIR" ]; then
              echo "üì¶ Criando backup da vers√£o anterior..."
              cp -r "$TARGET_DIR" "$BACKUP_DIR"
              echo "‚úÖ Backup criado em: $BACKUP_DIR"
            fi
            
            # Criar diret√≥rio de destino
            echo "üìÅ Preparando diret√≥rio $TARGET_DIR..."
            mkdir -p "$TARGET_DIR"
            
            # Limpar arquivos antigos
            echo "üßπ Limpando arquivos antigos..."
            rm -rf "$TARGET_DIR"/*
            
            # Extrair novo pacote
            echo "üì¶ Extraindo pacote..."
            unzip -o "$DEPLOY_ZIP" -d "$TARGET_DIR"
            
            # Ajustar permiss√µes
            echo "üîê Ajustando permiss√µes..."
            chmod +x "$TARGET_DIR"/*.py || true
            find "$TARGET_DIR" -type f -name "*.py" -exec chmod 755 {} \;
            
            # Instalar depend√™ncias Python (se requirements.txt existir)
            if [ -f "$TARGET_DIR/requirements.txt" ]; then
              echo "üì¶ Instalando depend√™ncias Python..."
              if command -v python3 &> /dev/null; then
                python3 -m pip install --user -r "$TARGET_DIR/requirements.txt" || echo "‚ö†Ô∏è Falha ao instalar depend√™ncias (pode ser normal se j√° estiver instalado)"
              else
                echo "‚ö†Ô∏è Python3 n√£o encontrado!"
              fi
            fi
            
            # Verificar instala√ß√£o
            echo ""
            echo "=========================================="
            echo "  ‚úÖ Deploy conclu√≠do com sucesso!"
            echo "=========================================="
            echo ""
            echo "üìÇ Localiza√ß√£o: $TARGET_DIR"
            echo "üìã Arquivos instalados:"
            ls -lh "$TARGET_DIR" | head -20
            echo ""
            
            # Mostrar informa√ß√µes do build
            if [ -f "$TARGET_DIR/BUILD_INFO.txt" ]; then
              echo "üìù Informa√ß√µes do Build:"
              cat "$TARGET_DIR/BUILD_INFO.txt"
              echo ""
            fi
            
            # Verificar se Python est√° instalado
            if command -v python3 &> /dev/null; then
              echo "‚úÖ Python instalado: $(python3 --version)"
            else
              echo "‚ö†Ô∏è Python n√£o encontrado!"
            fi
            
            # Verificar se requests est√° instalado
            if python3 -c "import requests" 2>/dev/null; then
              echo "‚úÖ Biblioteca 'requests' instalada"
            else
              echo "‚ö†Ô∏è Biblioteca 'requests' n√£o encontrada!"
              echo "   Execute: python3 -m pip install --user -r $TARGET_DIR/requirements.txt"
            fi
            
            echo ""
            echo "=========================================="
            echo "  üìã Como executar:"
            echo "=========================================="
            echo "  cd ~/SITECOM/Tests"
            echo "  export buslog_token='seu_token_aqui'"
            echo "  python3 send_buslog.py buslog.json"
            echo ""
            echo "  Ou configure no cron (conforme necess√°rio):"
            echo "  0 * * * * cd ~/SITECOM/Tests && export buslog_token='\$TOKEN' && /usr/bin/python3 send_buslog.py buslog.json >> ~/SITECOM/Tests/buslog.log 2>&1"
            echo "=========================================="

  close-ssh-port:
    name: Fechar porta SSH AWS (22)
    runs-on: ubuntu-latest
    needs: [ open-ssh-port, deploy-bastion ]
    if: always()
    steps:
      - name: Configurar credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Fechar porta SSH
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.BASTION_SG_ID }} \
            --protocol tcp --port 22 --cidr 0.0.0.0/0 || echo "‚ö†Ô∏è Regra j√° removida"

  post-actions:
    name: Post Actions
    runs-on: ubuntu-latest
    needs: [ prepare-files, transfer-bastion, deploy-bastion, close-ssh-port ]
    if: always()
    steps:
      - name: Resumo
        run: |
          echo "=========================================="
          echo "  üèÅ Pipeline SITECOM Tests Finalizado"
          echo "=========================================="
          echo ""
          echo "üìä Status dos Jobs:"
          echo "  prepare-files: ${{ needs.prepare-files.result }}"
          echo "  transfer-bastion: ${{ needs['transfer-bastion'].result }}"
          echo "  deploy-bastion: ${{ needs['deploy-bastion'].result }}"
          echo "  close-ssh-port: ${{ needs['close-ssh-port'].result }}"
          echo ""
          echo "=========================================="
          
          if [ "${{ needs.prepare-files.result }}" == "success" ] && \
             [ "${{ needs['transfer-bastion'].result }}" == "success" ] && \
             [ "${{ needs['deploy-bastion'].result }}" == "success" ]; then
            echo "‚úÖ Deploy conclu√≠do com sucesso!"
            echo "üìÇ Aplica√ß√£o dispon√≠vel em: ~/SITECOM/Tests"
            echo "üöÄ Execute manualmente ou configure no cron"
            echo ""
            echo "üí° Lembrete: Configure a vari√°vel de ambiente 'buslog_token' antes de executar"
          else
            echo "‚ùå Pipeline teve falhas. Verifique os logs acima."
          fi

