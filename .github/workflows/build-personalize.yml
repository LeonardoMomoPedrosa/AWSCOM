name: Build Personalize (.NET 8)

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'SITECOM/Personalize/**'
      - '.github/workflows/build-personalize.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'SITECOM/Personalize/**'
  workflow_dispatch:

jobs:

  pre-actions:
    name: Pre Actions
    runs-on: ubuntu-latest
    steps:
      - name: Contexto
        run: |
          echo "üîß Iniciando pipeline Personalize..."
          echo "üì¶ Job execut√°vel para sistema de personaliza√ß√£o de produtos"

  open-ssh-port:
    name: Abrir porta SSH AWS (22)
    runs-on: ubuntu-latest
    needs: pre-actions
    steps:
      - name: Configurar credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Abrir porta SSH temporariamente
        run: |
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.BASTION_SG_ID }} \
            --protocol tcp --port 22 --cidr 0.0.0.0/0 || echo "‚ö†Ô∏è Regra j√° existente"

  build:
    name: Build (.NET 8)
    runs-on: ubuntu-latest
    needs: pre-actions
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Checkout do SLCOMLIB
        uses: actions/checkout@v4
        with:
          repository: LeonardoMomoPedrosa/SLCOMLIB
          token: ${{ secrets.GH_PAT }}
          path: SLCOMLIB

      - name: Instalar .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restaurar depend√™ncias
        working-directory: SITECOM/Personalize
        run: dotnet restore Personalize.csproj /p:SLCOMLIBPath=../../SLCOMLIB/SLCOMLIB.csproj

      - name: Compilar o projeto
        working-directory: SITECOM/Personalize
        run: dotnet build Personalize.csproj --configuration Release --no-restore /p:SLCOMLIBPath=../../SLCOMLIB/SLCOMLIB.csproj

      - name: Publicar (gera o execut√°vel pronto para Linux)
        working-directory: SITECOM/Personalize
        run: dotnet publish Personalize.csproj -c Release -r linux-x64 -o ../../publish-personalize --self-contained false /p:SLCOMLIBPath=../../SLCOMLIB/SLCOMLIB.csproj

      - name: Verificar se appsettings.json foi copiado
        run: |
          if [ -f "publish-personalize/appsettings.json" ]; then
            echo "‚úÖ appsettings.json encontrado no publish"
            ls -lh publish-personalize/appsettings.json
          else
            echo "‚ö†Ô∏è appsettings.json N√ÉO encontrado no publish!"
            echo "Copiando do diret√≥rio fonte..."
            cp SITECOM/Personalize/appsettings.json publish-personalize/appsettings.json
            echo "‚úÖ appsettings.json copiado"
          fi

      - name: Remover appsettings de desenvolvimento
        run: |
          if [ -f "publish-personalize/appsettings.Development.json" ]; then
            rm -f publish-personalize/appsettings.Development.json
            echo "‚úÖ appsettings.Development.json removido"
          fi

      - name: Criar arquivo de informa√ß√µes do build
        run: |
          cat > publish-personalize/BUILD_INFO.txt <<EOF
          Build: ${{ github.run_number }}
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Data: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Autor: ${{ github.actor }}
          EOF

      - name: Compactar o resultado
        run: |
          cd publish-personalize
          zip -r ../personalize.zip .
          cd ..
          ls -lh personalize.zip

      - name: Armazenar artefato no GitHub
        uses: actions/upload-artifact@v4
        with:
          name: Personalize
          path: personalize.zip
          retention-days: 30

  transfer-bastion:
    name: Transfer para Bastion
    runs-on: ubuntu-latest
    needs: [ build, open-ssh-port ]
    steps:
      - name: Aguardar propaga√ß√£o da regra SSH
        run: |
          echo "‚è≥ Aguardando 10 segundos para garantir que a porta SSH est√° aberta..."
          sleep 10
          echo "‚úÖ Prosseguindo com o transfer"
      
      - name: Testar conectividade SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USERNAME }}
          key: ${{ secrets.BASTION_SSH_KEY }}
          script: |
            echo "‚úÖ Conectado no Bastion com sucesso!"
            whoami
            pwd
            ls -la /home/ec2-user/deploys/ || mkdir -p /home/ec2-user/deploys/
      
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: Personalize

      - name: Verificar arquivo baixado
        run: |
          echo "=== Conte√∫do do diret√≥rio atual ==="
          pwd
          ls -la
          echo ""
          echo "=== Verificando arquivo espec√≠fico ==="
          if [ -f "personalize.zip" ]; then
            ls -lh personalize.zip
            echo "‚úÖ Arquivo encontrado!"
          else
            echo "‚ùå Arquivo personalize.zip N√ÉO encontrado!"
            echo "Procurando arquivos .zip:"
            find . -name "*.zip" -type f
          fi

      - name: Enviar artefato para o Bastion
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USERNAME }}
          key: ${{ secrets.BASTION_SSH_KEY }}
          source: "personalize.zip"
          target: "/home/ec2-user/deploys/"

  deploy-bastion:
    name: Deploy no Bastion
    runs-on: ubuntu-latest
    needs: transfer-bastion
    steps:
      - name: Descompactar e configurar no Bastion
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USERNAME }}
          key: ${{ secrets.BASTION_SSH_KEY }}
          script_stop: false
          script: |
            set -e
            echo "=========================================="
            echo "  Deploy Personalize no Bastion"
            echo "=========================================="
            
            DEPLOY_ZIP="/home/ec2-user/deploys/personalize.zip"
            TARGET_DIR="$HOME/Personalize"
            BACKUP_DIR="$HOME/Personalize-backup-$(date +%Y%m%d-%H%M%S)"
            
            # Verificar se arquivo foi enviado
            if [ ! -f "$DEPLOY_ZIP" ]; then
              echo "‚ùå Arquivo $DEPLOY_ZIP n√£o encontrado!"
              exit 1
            fi
            
            echo "‚úÖ Arquivo encontrado: $DEPLOY_ZIP"
            ls -lh "$DEPLOY_ZIP"
            
            # Fazer backup da vers√£o anterior (se existir)
            if [ -d "$TARGET_DIR" ]; then
              echo "üì¶ Criando backup da vers√£o anterior..."
              sudo cp -r "$TARGET_DIR" "$BACKUP_DIR"
              echo "‚úÖ Backup criado em: $BACKUP_DIR"
            fi
            
            # Criar diret√≥rio de destino
            echo "üìÅ Preparando diret√≥rio $TARGET_DIR..."
            mkdir -p "$TARGET_DIR"
            
            # Limpar arquivos antigos
            echo "üßπ Limpando arquivos antigos..."
            rm -rf "$TARGET_DIR"/*
            
            # Extrair novo pacote
            echo "üì¶ Extraindo pacote..."
            unzip -o "$DEPLOY_ZIP" -d "$TARGET_DIR"
            
            # Verificar se appsettings.json foi extra√≠do
            if [ ! -f "$TARGET_DIR/appsettings.json" ]; then
              echo "‚ùå appsettings.json n√£o encontrado no pacote! Abortando deploy."
              exit 1
            fi
            echo "‚úÖ appsettings.json encontrado no pacote"
            
            # Ajustar permiss√µes
            echo "üîê Ajustando permiss√µes..."
            chmod +x "$TARGET_DIR/Personalize"
            
            # Verificar instala√ß√£o
            echo ""
            echo "=========================================="
            echo "  ‚úÖ Deploy conclu√≠do com sucesso!"
            echo "=========================================="
            echo ""
            echo "üìÇ Localiza√ß√£o: $TARGET_DIR"
            echo "üìã Arquivos instalados:"
            ls -lh "$TARGET_DIR" | head -20
            echo ""
            
            # Mostrar informa√ß√µes do build
            if [ -f "$TARGET_DIR/BUILD_INFO.txt" ]; then
              echo "üìù Informa√ß√µes do Build:"
              cat "$TARGET_DIR/BUILD_INFO.txt"
              echo ""
            fi
            
            # Verificar se .NET est√° instalado
            if command -v dotnet &> /dev/null; then
              echo "‚úÖ .NET Runtime instalado: $(dotnet --version)"
            else
              echo "‚ö†Ô∏è .NET Runtime n√£o encontrado!"
              echo "   Instale com: sudo dnf install dotnet-runtime-8.0 -y"
            fi
            
            echo ""
            echo "=========================================="
            echo "  üìã Como executar:"
            echo "=========================================="
            echo "  cd ~/Personalize"
            echo "  dotnet Personalize.dll"
            echo ""
            echo "  Ou configure no cron (execu√ß√£o semanal):"
            echo "  0 2 * * 1 cd ~/Personalize && ~/.dotnet/dotnet Personalize.dll >> ~/Personalize/personalize.log 2>&1"
            echo "  (Executa toda segunda-feira √†s 2h)"
            echo ""
            echo "  Para primeira execu√ß√£o, configure FirstRun=true no appsettings.json"
            echo "  Para execu√ß√µes semanais, configure FirstRun=false no appsettings.json"
            echo "=========================================="

  close-ssh-port:
    name: Fechar porta SSH AWS (22)
    runs-on: ubuntu-latest
    needs: [ open-ssh-port, deploy-bastion ]
    if: always()
    steps:
      - name: Configurar credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Fechar porta SSH
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.BASTION_SG_ID }} \
            --protocol tcp --port 22 --cidr 0.0.0.0/0 || echo "‚ö†Ô∏è Regra j√° removida"

  post-actions:
    name: Post Actions
    runs-on: ubuntu-latest
    needs: [ build, transfer-bastion, deploy-bastion, close-ssh-port ]
    if: always()
    steps:
      - name: Resumo
        run: |
          echo "=========================================="
          echo "  üèÅ Pipeline Personalize Finalizado"
          echo "=========================================="
          echo ""
          echo "üìä Status dos Jobs:"
          echo "  build: ${{ needs.build.result }}"
          echo "  transfer-bastion: ${{ needs['transfer-bastion'].result }}"
          echo "  deploy-bastion: ${{ needs['deploy-bastion'].result }}"
          echo "  close-ssh-port: ${{ needs['close-ssh-port'].result }}"
          echo ""
          echo "=========================================="
          
          if [ "${{ needs.build.result }}" == "success" ] && \
             [ "${{ needs['transfer-bastion'].result }}" == "success" ] && \
             [ "${{ needs['deploy-bastion'].result }}" == "success" ]; then
            echo "‚úÖ Deploy conclu√≠do com sucesso!"
            echo "üìÇ Aplica√ß√£o dispon√≠vel em: ~/Personalize"
            echo "üöÄ Execute manualmente ou configure no cron (semanal)"
          else
            echo "‚ùå Pipeline teve falhas. Verifique os logs acima."
          fi

